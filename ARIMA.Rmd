---
title: "ARIMA_new"
author: "April"
date: "10/27/2023"
output: html_document
---
Load packages
```{r}
pacman::p_load(astsa,tseries,forecast,strucchange,readr,dplyr,patchwork,pROC,outliers,ggplot2,yardstick)
```
Date time function
```{r}
DATETIME<-function(year,day,hour,minute,second){
  if (length(second)==0)
    second="00"
  time=paste(hour,minute,sep = ":")
  time=paste(time,second,sep = ":")
  day=as.numeric(day)
  date=case_when(
    year == 2000 ~ as.Date(day-1,origin="2000-01-01"),
    year == 2001 ~ as.Date(day-1,origin="2001-01-01"),
    year == 2002 ~ as.Date(day-1,origin="2002-01-01"),
    year == 2003 ~ as.Date(day-1,origin="2003-01-01"),
    year == 2004 ~ as.Date(day-1,origin="2004-01-01"),
    year == 2005 ~ as.Date(day-1,origin="2005-01-01"),
    year == 2006 ~ as.Date(day-1,origin="2006-01-01"),
    year == 2007 ~ as.Date(day-1,origin="2007-01-01"),
    year == 2008 ~ as.Date(day-1,origin="2008-01-01"),
    year == 2009 ~ as.Date(day-1,origin="2009-01-01"),
    year == 2010 ~ as.Date(day-1,origin="2010-01-01"),
    year == 2011 ~ as.Date(day-1,origin="2011-01-01"),
    year == 2012 ~ as.Date(day-1,origin="2012-01-01"),
    year == 2013 ~ as.Date(day-1,origin="2013-01-01"),
    year == 2014 ~ as.Date(day-1,origin="2014-01-01"),
    year == 2015 ~ as.Date(day-1,origin="2015-01-01"),
    year == 2016 ~ as.Date(day-1,origin="2016-01-01"),
    year == 2017 ~ as.Date(day-1,origin="2017-01-01"),
    year == 2018 ~ as.Date(day-1,origin="2018-01-01"),
    year == 2019 ~ as.Date(day-1,origin="2019-01-01"),
    year == 2020 ~ as.Date(day-1,origin="2020-01-01"),
    year == 2021 ~ as.Date(day-1,origin="2021-01-01"),
    year == 2022 ~ as.Date(day-1,origin="2022-01-01")
  )
  datetime=paste(date,time,sep = " ")
  datetime=as.POSIXct(datetime,TZ="UTC")
  return(datetime)
}
```


# cs2
Data preprocessing
```{r}
cs2_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_CryoSat-2.csv")
cs2_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/cs2man.txt",col_names = FALSE)

colname<-c("sate_id","year_begin","day_begin","hour_begin","min_begin","year_end","day_end","hour_end","min_end","type_para","burns","year_med","day_med","hour_med","min_med","second_med","boost_duration","DV1","DV2","DV3","acc1","acc2","acc3","dacc1","dacc2","dacc3")

colnames(cs2_manoeuvres)<-colname

cs2_manoeuvres <-
  cs2_manoeuvres %>%
  mutate(
    time_begin=DATETIME(year_begin,day_begin,hour_begin,min_begin,second = c()),
    time_end=DATETIME(year_end,day_end,hour_end,min_end,second = c()),
    time_med=DATETIME(year_med,day_med,hour_med,min_med,second_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(cs2_unpropogated)<-colname_orbit

# keep the first time in a day
cs2_unpropogated <- cs2_unpropogated %>%
  group_by(as.Date(cs2_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
# set up time series
cs2_ts <- ts(cs2_unpropogated$brouwer_mean_motion, start = c(2010,4,25))

# observe if there are structural breaks
plot(cs2_ts)

# computation of breakpoints in regression relationships
##########breakpoints(cs2_ts ~ 1)$breakpoints
# ouput: 3516

# observe breakpoints on time series
ggplot() +
  geom_line(aes(time,brouwer_mean_motion),data=cs2_unpropogated)+
  geom_vline(xintercept=cs2_unpropogated$time[3516],color="red")

# divide time series data into two periods
## part 1:
cs2_ts1 <- ts(cs2_unpropogated$brouwer_mean_motion[1:3516], start = c(2010,4,25))
## part 2:
cs2_ts2 <- ts(cs2_unpropogated$brouwer_mean_motion[3517:4308], start = c(2020,7,23))
```
## cs2-part1
```{r}
plot(cs2_ts1)

# find outliers
z_scores <- (cs2_ts1 - mean(cs2_ts1)) / sd(cs2_ts1)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(cs2_ts1),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
cs2_ts1_f <- cs2_ts1[-outlier_ind]
```
ACF and PACF
```{r}
acf(cs2_ts1_f)
pacf(cs2_ts1_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(cs2_ts1_f))
pacf(diff(cs2_ts1_f))
print(adf.test(diff(cs2_ts1_f)))
```
Fit models
```{r}
cs2_ts1_fit1 <- arima(cs2_ts1_f, order = c(0, 1, 1))
cs2_ts1_fit2 <- arima(cs2_ts1_f, order = c(0, 1, 2))
cs2_ts1_fit3 <- arima(cs2_ts1_f, order = c(1, 1, 1))
cs2_ts1_fit4 <- arima(cs2_ts1_f, order = c(1, 1, 2))
```
```{r}
cs2_ts1_fit1$aic
cs2_ts1_fit2$aic
cs2_ts1_fit3$aic # best
cs2_ts1_fit4$aic
```
```{r}
sarima(cs2_ts1_f,1,1,1) # good
cpgram(cs2_ts1_fit3$residuals) # not so good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(cs2_ts1_fit3$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- cs2_ts1_fit3$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(cs2_manoeuvres$time_med) == as.Date(cs2_unpropogated$time[1:3516])
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(cs2_unpropogated$time[1:3516])) {
  is_match <- as.Date(cs2_unpropogated$time[1:3516])[i] %in% as.Date(cs2_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
cs2_ts1_date <- final_date_result
cs2_ts1_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)

# 0.816
```
## cs2-part2
```{r}
plot(cs2_ts2)

# find outliers
z_scores <- (cs2_ts2 - mean(cs2_ts2)) / sd(cs2_ts2)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(cs2_ts2),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
cs2_ts2_f <- cs2_ts2[-outlier_ind]
```
ACF and PACF
```{r}
acf(cs2_ts2_f)
pacf(cs2_ts2_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(cs2_ts2_f))
pacf(diff(cs2_ts2_f))
print(adf.test(diff(cs2_ts2_f)))
```
Fit models
```{r}
cs2_ts2_fit1 <- arima(cs2_ts2_f, order = c(0, 1, 1))
cs2_ts2_fit2 <- arima(cs2_ts2_f, order = c(0, 1, 2))
cs2_ts2_fit3 <- arima(cs2_ts2_f, order = c(1, 1, 1))
cs2_ts2_fit4 <- arima(cs2_ts2_f, order = c(1, 1, 2))
cs2_ts2_fit5 <- arima(cs2_ts2_f, order = c(2, 1, 2))
```
```{r}
cs2_ts2_fit1$aic
cs2_ts2_fit2$aic
cs2_ts2_fit3$aic 
cs2_ts2_fit4$aic
cs2_ts2_fit5$aic # best
```
```{r}
sarima(cs2_ts2_f,2,1,2) # good
cpgram(cs2_ts2_fit5$residuals) # good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(cs2_ts2_fit5$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- cs2_ts2_fit5$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(cs2_manoeuvres$time_med) == as.Date(cs2_unpropogated$time[3517:4308])
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(cs2_unpropogated$time[3517:4308])) {
  is_match <- as.Date(cs2_unpropogated$time[3517:4308])[i] %in% as.Date(cs2_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
cs2_ts2_date <- final_date_result
cs2_ts2_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)

# 0.832
```
## all parts
```{r}
cs2_ts_date <- c(cs2_ts1_date, cs2_ts2_date)
cs2_ts_res <- c(cs2_ts1_res, cs2_ts2_res)
roc_curve <- roc(cs2_ts_date,cs2_ts_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.819
dat <- data.frame(truth = as.factor(cs2_ts_date), pred_1 = as.numeric(cs2_ts_res), pred_2 = 1-as.numeric(cs2_ts_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.545,y=0.370,col="red",pch=8)+
  geom_point(x=0.699,y=0.353,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# s3a
Data preprocessing
```{r}
s3a_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Sentinel-3A.csv")
s3a_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/s3aman.txt",col_names = FALSE)

colname<-c("sate_id","year_begin","day_begin","hour_begin","min_begin","year_end","day_end","hour_end","min_end","type_para","burns","year_med","day_med","hour_med","min_med","second_med","boost_duration","DV1","DV2","DV3","acc1","acc2","acc3","dacc1","dacc2","dacc3")

colnames(s3a_manoeuvres)<-colname

# keep columns with name
s3a_manoeuvres <- s3a_manoeuvres[, 1:26]

s3a_manoeuvres <-
  s3a_manoeuvres %>%
  mutate(
    time_begin=DATETIME(year_begin,day_begin,hour_begin,min_begin,second = c()),
    time_end=DATETIME(year_end,day_end,hour_end,min_end,second = c()),
    time_med=DATETIME(year_med,day_med,hour_med,min_med,second_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(s3a_unpropogated)<-colname_orbit

# keep the first time in a day
s3a_unpropogated <- s3a_unpropogated %>%
  group_by(as.Date(s3a_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
# set up time series
s3a_ts <- ts(s3a_unpropogated$brouwer_mean_motion, start = c(2016,3,4))

# observe if there are structural breaks
plot(s3a_ts)
```
```{r}
# find outliers
z_scores <- (s3a_ts - mean(s3a_ts)) / sd(s3a_ts)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(s3a_ts),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
s3a_ts_f <- s3a_ts[-outlier_ind]
```
ACF and PACF
```{r}
acf(s3a_ts_f)
pacf(s3a_ts_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(s3a_ts_f))
pacf(diff(s3a_ts_f))
print(adf.test(diff(s3a_ts_f)))
```
Fit models
```{r}
s3a_ts_fit1 <- arima(s3a_ts_f, order = c(0, 1, 1))
s3a_ts_fit2 <- arima(s3a_ts_f, order = c(1, 1, 1))
s3a_ts_fit3 <- arima(s3a_ts_f, order = c(2, 1, 1))
```
```{r}
s3a_ts_fit1$aic # best
s3a_ts_fit2$aic
s3a_ts_fit3$aic
```
```{r}
sarima(s3a_ts_f,0,1,1) # good
cpgram(s3a_ts_fit1$residuals) # good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(s3a_ts_fit1$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- s3a_ts_fit1$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(s3a_manoeuvres$time_med) == as.Date(s3a_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(s3a_unpropogated$time)) {
  is_match <- as.Date(s3a_unpropogated$time)[i] %in% as.Date(s3a_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
s3a_ts_date <- final_date_result
s3a_ts_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.801
dat <- data.frame(truth = as.factor(s3a_ts_date), pred_1 = as.numeric(s3a_ts_res), pred_2 = 1-as.numeric(s3a_ts_res))

pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.438,y=0.724,col="red",pch=8)+
  geom_point(x=0.542,y=0.650,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
#0.459
```


# h2a
Data preprocessing
```{r}
h2a_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Haiyang-2A.csv")
h2a_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/h2aman.txt",col_names = FALSE)

colname<-c("sate_id","year_begin","day_begin","hour_begin","min_begin","year_end","day_end","hour_end","min_end","type_para","burns","year_med","day_med","hour_med","min_med","second_med","boost_duration","DV1","DV2","DV3","acc1","acc2","acc3","dacc1","dacc2","dacc3")

colnames(h2a_manoeuvres)<-colname

h2a_manoeuvres <-
  h2a_manoeuvres %>%
  mutate(
    time_begin=DATETIME(year_begin,day_begin,hour_begin,min_begin,second = c()),
    time_end=DATETIME(year_end,day_end,hour_end,min_end,second = c()),
    time_med=DATETIME(year_med,day_med,hour_med,min_med,second_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(h2a_unpropogated)<-colname_orbit

# keep the first time in a day
h2a_unpropogated <- h2a_unpropogated %>%
  group_by(as.Date(h2a_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
# set up time series
h2a_ts <- ts(h2a_unpropogated$brouwer_mean_motion, start = c(2011,10,8))

# observe if there are structural breaks
plot(h2a_ts)

# computation of breakpoints in regression relationships
###########breakpoints(h2a_ts ~ 1)$breakpoints
# ouput: 831 1566 2079 2528

# observe breakpoints on time series
ggplot() +
  geom_line(aes(time,brouwer_mean_motion),data=h2a_unpropogated)+
  geom_vline(xintercept=h2a_unpropogated$time[c(831, 1566, 2079, 2528)],color="red")
# choose 831, 1566

# divide time series data into two periods
## part 1:
h2a_ts1 <- ts(h2a_unpropogated$brouwer_mean_motion[1:831], start = c(2011,10,8))
## part 2:
h2a_ts2 <- ts(h2a_unpropogated$brouwer_mean_motion[832:1566], start = c(2014,1,29))
## part 3:
h2a_ts3 <- ts(h2a_unpropogated$brouwer_mean_motion[1567:2998], start = c(2016,3,19))
```
## h2a-part1
```{r}
plot(h2a_ts1)

# find outliers
z_scores <- (h2a_ts1 - mean(h2a_ts1)) / sd(h2a_ts1)
outlier_ind <- which(abs(z_scores) > 3)
# no outlier
```
ACF and PACF
```{r}
acf(h2a_ts1)
pacf(h2a_ts1)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(h2a_ts1))
pacf(diff(h2a_ts1))
print(adf.test(diff(h2a_ts1)))
spectrum(diff(h2a_ts1))
```
Fit models
```{r}
h2a_ts1_fit1 <- arima(h2a_ts1, order = c(0, 1, 2))
h2a_ts1_fit2 <- arima(h2a_ts1, order = c(1, 1, 2))
h2a_ts1_fit3 <- arima(h2a_ts1, order = c(2, 1, 2))
h2a_ts1_fit4 <- arima(h2a_ts1, order = c(3, 1, 2))
h2a_ts1_fit5 <- arima(h2a_ts1, order = c(3, 1, 3))
```
```{r}
h2a_ts1_fit1$aic
h2a_ts1_fit2$aic
h2a_ts1_fit3$aic
h2a_ts1_fit4$aic
h2a_ts1_fit5$aic # best
```
```{r}
sarima(h2a_ts1,3,1,2) # good
cpgram(h2a_ts1_fit5$residuals) # very bad
```
```{r}
# select dates of manoeuvres in each part
same_date <- as.Date(h2a_manoeuvres$time_med) == as.Date(h2a_unpropogated$time[1:831])
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(h2a_unpropogated$time[1:831])) {
  is_match <- as.Date(h2a_unpropogated$time[1:831])[i] %in% as.Date(h2a_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(h2a_ts1_fit5$residuals)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
h2a_ts1_date <- final_date_result
h2a_ts1_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.472

```
## h2a-part2
```{r}
plot(h2a_ts2)

# find outliers
z_scores <- (h2a_ts2 - mean(h2a_ts2)) / sd(h2a_ts2)
outlier_ind <- which(abs(z_scores) > 3)
# 734 735

# assign the outliers to NA
spare <- seq(1,length(h2a_ts2),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
h2a_ts2_f <- h2a_ts2[-outlier_ind]
```
ACF and PACF
```{r}
acf(h2a_ts2)
pacf(h2a_ts2)
print(adf.test(h2a_ts2))
```
According to adf test, we decide to take the difference
```{r}
print(adf.test(diff(diff(diff(diff(h2a_ts2))))))
# four times' difference
acf(diff(diff(diff(diff(h2a_ts2)))))
pacf(diff(diff(diff(diff(h2a_ts2)))))
```
Fit models
```{r}
h2a_ts2_fit1 <- arima(h2a_ts2, order = c(1, 4, 1))
h2a_ts2_fit2 <- arima(h2a_ts2, order = c(1, 4, 2))
h2a_ts2_fit3 <- arima(h2a_ts2, order = c(2, 4, 1))
h2a_ts2_fit4 <- arima(h2a_ts2, order = c(2, 4, 2))
```
```{r}
h2a_ts2_fit1$aic # best
h2a_ts2_fit2$aic
h2a_ts2_fit3$aic
h2a_ts2_fit4$aic
```
```{r}
sarima(h2a_ts2,1,4,1) # bad
cpgram(h2a_ts2_fit1$residuals) # very bad
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(h2a_ts2_fit1$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- h2a_ts2_fit1$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(h2a_manoeuvres$time_med) == as.Date(h2a_unpropogated$time[832:1566])
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(h2a_unpropogated$time[832:1566])) {
  is_match <- as.Date(h2a_unpropogated$time[832:1566])[i] %in% as.Date(h2a_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
h2a_ts2_date <- final_date_result
h2a_ts2_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.621
```
## h2a-part3
```{r}
plot(h2a_ts3)

# find outliers
z_scores <- (h2a_ts3 - mean(h2a_ts3)) / sd(h2a_ts3)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(h2a_ts3),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
h2a_ts3_f <- h2a_ts3[-outlier_ind]
```
ACF and PACF
```{r}
acf(h2a_ts3_f)
pacf(h2a_ts3_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(h2a_ts3_f))
pacf(diff(h2a_ts3_f))
print(adf.test(diff(h2a_ts3_f)))
```
Fit models
```{r}
h2a_ts3_fit1 <- arima(h2a_ts3_f, order = c(0, 1, 2))
h2a_ts3_fit2 <- arima(h2a_ts3_f, order = c(1, 1, 2))
h2a_ts3_fit3 <- arima(h2a_ts3_f, order = c(2, 1, 2))
```
```{r}
h2a_ts3_fit1$aic
h2a_ts3_fit2$aic # best
h2a_ts3_fit3$aic
```
```{r}
sarima(h2a_ts3_f,1,1,1) # good
cpgram(h2a_ts3_fit2$residuals) # good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(h2a_ts3_fit2$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- h2a_ts3_fit2$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(h2a_manoeuvres$time_med) == as.Date(h2a_unpropogated$time[1567:2998])
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(h2a_unpropogated$time[1567:2998])) {
  is_match <- as.Date(h2a_unpropogated$time[1567:2998])[i] %in% as.Date(h2a_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
h2a_ts3_date <- final_date_result
h2a_ts3_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.650
```
## all parts
```{r}
h2a_ts_date <- c(h2a_ts1_date, h2a_ts2_date)
h2a_ts_date <- c(h2a_ts_date, h2a_ts3_date)
h2a_ts_res <- c(h2a_ts1_res, h2a_ts2_res)
h2a_ts_res <- c(h2a_ts_res, h2a_ts3_res)
roc_curve <- roc(h2a_ts_date,h2a_ts_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.570
dat <- data.frame(truth = as.factor(h2a_ts_date), pred_1 = as.numeric(h2a_ts_res), pred_2 = 1-as.numeric(h2a_ts_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.020,y=0.333,col="red",pch=8)+
  geom_point(x=0.020,y=0.200,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# s3b
Data preprocessing
```{r}
s3b_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Sentinel-3B.csv")
s3b_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/s3bman.txt",col_names = FALSE)

colname<-c("sate_id","year_begin","day_begin","hour_begin","min_begin","year_end","day_end","hour_end","min_end","type_para","burns","year_med","day_med","hour_med","min_med","second_med","boost_duration","DV1","DV2","DV3","acc1","acc2","acc3","dacc1","dacc2","dacc3")

colnames(s3b_manoeuvres)<-colname

# keep columns with name
s3b_manoeuvres <- s3b_manoeuvres[, 1:26]

s3b_manoeuvres <-
  s3b_manoeuvres %>%
  mutate(
    time_begin=DATETIME(year_begin,day_begin,hour_begin,min_begin,second = c()),
    time_end=DATETIME(year_end,day_end,hour_end,min_end,second = c()),
    time_med=DATETIME(year_med,day_med,hour_med,min_med,second_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(s3b_unpropogated)<-colname_orbit

# keep the first time in a day
s3b_unpropogated <- s3b_unpropogated %>%
  group_by(as.Date(s3b_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
# set up time series
s3b_ts <- ts(s3b_unpropogated$brouwer_mean_motion, start = c(2018,5,10))

# observe if there are structural breaks
plot(s3b_ts)
```
```{r}
# find outliers
z_scores <- (s3b_ts - mean(s3b_ts)) / sd(s3b_ts)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(s3b_ts),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
s3b_ts_f <- s3b_ts[-outlier_ind]
```
ACF and PACF
```{r}
acf(s3b_ts_f)
pacf(s3b_ts_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(s3b_ts_f))
pacf(diff(s3b_ts_f))
print(adf.test(diff(s3b_ts_f)))
```
Fit models
```{r}
s3b_ts_fit1 <- arima(s3b_ts_f, order = c(2, 1, 1))
s3b_ts_fit2 <- arima(s3b_ts_f, order = c(1, 1, 2))
s3b_ts_fit3 <- arima(s3b_ts_f, order = c(2, 1, 2))
s3b_ts_fit4 <- arima(s3b_ts_f, order = c(3, 1, 2))
s3b_ts_fit5 <- arima(s3b_ts_f, order = c(2, 1, 3))
s3b_ts_fit6 <- arima(s3b_ts_f, order = c(3, 1, 3))
```
```{r}
s3b_ts_fit1$aic
s3b_ts_fit2$aic
s3b_ts_fit3$aic
s3b_ts_fit4$aic
s3b_ts_fit4$aic # best
s3b_ts_fit5$aic
```
```{r}
sarima(s3b_ts_f,2,1,3) # good
cpgram(s3b_ts_fit5$residuals) # good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(s3b_ts_fit5$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- s3b_ts_fit5$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(s3b_manoeuvres$time_med) == as.Date(s3b_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(s3b_unpropogated$time)) {
  is_match <- as.Date(s3b_unpropogated$time)[i] %in% as.Date(s3b_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
s3b_ts_date <- final_date_result
s3b_ts_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.751
dat <- data.frame(truth = as.factor(s3b_ts_date), pred_1 = as.numeric(s3b_ts_res), pred_2 = 1-as.numeric(s3b_ts_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.568,y=0.677,col="red",pch=8)+
  geom_point(x=0.703,y=0.413,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```





# s6a
Data preprocessing
```{r}
s6a_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Sentinel-6A.csv")
s6a_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/s6aman.txt",col_names = FALSE)

colname<-c("sate_id","year_begin","day_begin","hour_begin","min_begin","year_end","day_end","hour_end","min_end","type_para","burns","year_med","day_med","hour_med","min_med","second_med","boost_duration","DV1","DV2","DV3","acc1","acc2","acc3","dacc1","dacc2","dacc3")

colnames(s6a_manoeuvres)<-colname

s6a_manoeuvres <-
  s6a_manoeuvres %>%
  mutate(
    time_begin=DATETIME(year_begin,day_begin,hour_begin,min_begin,second = c()),
    time_end=DATETIME(year_end,day_end,hour_end,min_end,second = c()),
    time_med=DATETIME(year_med,day_med,hour_med,min_med,second_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(s6a_unpropogated)<-colname_orbit

# keep the first time in a day
s6a_unpropogated <- s6a_unpropogated %>%
  group_by(as.Date(s6a_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
# set up time series
s6a_ts <- ts(s6a_unpropogated$brouwer_mean_motion, start = c(2020,12,5))

# observe if there are structural breaks
plot(s6a_ts)
```
```{r}
# find outliers
z_scores <- (s6a_ts - mean(s6a_ts)) / sd(s6a_ts)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(s6a_ts),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
s6a_ts_f <- s6a_ts[-outlier_ind]
```
ACF and PACF
```{r}
acf(s6a_ts_f)
pacf(s6a_ts_f)
print(adf.test(s6a_ts_f))
```
Fit models
```{r}
s6a_ts_fit1 <- arima(s6a_ts_f, order = c(2, 0, 2))
s6a_ts_fit2 <- arima(s6a_ts_f, order = c(3, 0, 2))
s6a_ts_fit3 <- arima(s6a_ts_f, order = c(2, 0, 3))
s6a_ts_fit4 <- arima(s6a_ts_f, order = c(2, 1, 2))
```
```{r}
s6a_ts_fit1$aic # best
s6a_ts_fit2$aic
s6a_ts_fit3$aic
s6a_ts_fit4$aic
```
```{r}
sarima(s6a_ts_f,2,0,2) # bad
cpgram(s6a_ts_fit1$residuals) # bad
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(s6a_ts_fit1$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- s6a_ts_fit1$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(s6a_manoeuvres$time_med) == as.Date(s6a_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(s6a_unpropogated$time)) {
  is_match <- as.Date(s6a_unpropogated$time)[i] %in% as.Date(s6a_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1
}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
s6a_ts_date <- final_date_result
s6a_ts_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.637
dat <- data.frame(truth = as.factor(s6a_ts_date), pred_1 = as.numeric(s6a_ts_res), pred_2 = 1-as.numeric(s6a_ts_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.143,y=0.167,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# ja1
Data preprocessing
```{r}
ja1_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Jason-1.csv")
ja1_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/ja1man.txt",col_names = FALSE)

colname<-c("sate_id","year_begin","day_begin","hour_begin","min_begin","year_end","day_end","hour_end","min_end","type_para","burns","year_med","day_med","hour_med","min_med","second_med","boost_duration","DV1","DV2","DV3","acc1","acc2","acc3","dacc1","dacc2","dacc3")

colnames(ja1_manoeuvres)<-colname

# keep columns with name
ja1_manoeuvres <- ja1_manoeuvres[, 1:26]

ja1_manoeuvres <-
  ja1_manoeuvres %>%
  mutate(
    time_begin=DATETIME(year_begin,day_begin,hour_begin,min_begin,second = c()),
    time_end=DATETIME(year_end,day_end,hour_end,min_end,second = c()),
    time_med=DATETIME(year_med,day_med,hour_med,min_med,second_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(ja1_unpropogated)<-colname_orbit

# keep the first time in a day
ja1_unpropogated <- ja1_unpropogated %>%
  group_by(as.Date(ja1_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
# set up time series
ja1_ts <- ts(ja1_unpropogated$brouwer_mean_motion, start = c(2001,12,22))

# observe if there are structural breaks
plot(ja1_ts)
```
```{r}
# find outliers
z_scores <- (ja1_ts - mean(ja1_ts)) / sd(ja1_ts)
outlier_ind <- which(abs(z_scores) > 3)
# many outliers

# assign the outliers to NA
spare <- seq(1,length(ja1_ts),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
ja1_ts_f <- ja1_ts[-outlier_ind]
```
ACF and PACF
```{r}
acf(ja1_ts_f)
pacf(ja1_ts_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(ja1_ts_f))
pacf(diff(ja1_ts_f))
print(adf.test(diff(ja1_ts_f)))
```
Fit models
```{r}
ja1_ts_fit1 <- arima(ja1_ts_f, order = c(0, 1, 2))
ja1_ts_fit2 <- arima(ja1_ts_f, order = c(1, 1, 2))
ja1_ts_fit3 <- arima(ja1_ts_f, order = c(2, 1, 2))
```
```{r}
ja1_ts_fit1$aic
ja1_ts_fit2$aic # best
ja1_ts_fit3$aic
```
```{r}
sarima(ja1_ts_f,0,1,2) # good
cpgram(ja1_ts_fit2$residuals) # not good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(ja1_ts_fit2$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- ja1_ts_fit2$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(ja1_manoeuvres$time_med) == as.Date(ja1_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(ja1_unpropogated$time)) {
  is_match <- as.Date(ja1_unpropogated$time)[i] %in% as.Date(ja1_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1
}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
ja1_ts_date <- final_date_result
ja1_ts_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.650
dat <- data.frame(truth = as.factor(ja1_ts_date), pred_1 = as.numeric(ja1_ts_res), pred_2 = 1-as.numeric(ja1_ts_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.074,y=0.417,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# ja2
Data preprocessing
```{r}
ja2_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Jason-2.csv")
ja2_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/ja2man.txt",col_names = FALSE)

colname<-c("sate_id","year_begin","day_begin","hour_begin","min_begin","year_end","day_end","hour_end","min_end","type_para","burns","year_med","day_med","hour_med","min_med","second_med","boost_duration","DV1","DV2","DV3","acc1","acc2","acc3","dacc1","dacc2","dacc3")

colnames(ja2_manoeuvres)<-colname

# keep columns with name
ja2_manoeuvres <- ja2_manoeuvres[1:109, 1:26]

ja2_manoeuvres <-
  ja2_manoeuvres %>%
  mutate(
    time_begin=DATETIME(year_begin,day_begin,hour_begin,min_begin,second = c()),
    time_end=DATETIME(year_end,day_end,hour_end,min_end,second = c()),
    time_med=DATETIME(year_med,day_med,hour_med,min_med,second_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(ja2_unpropogated)<-colname_orbit

# keep the first time in a day
ja2_unpropogated <- ja2_unpropogated %>%
  group_by(as.Date(ja2_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
ja2_ts <- ts(ja2_unpropogated$brouwer_mean_motion, start = c(2008,7,4))

# observe if there are structural breaks
plot(ja2_ts)

# computation of breakpoints in regression relationships
##############breakpoints(ja2_ts ~ 1)$breakpoints
# ouput: 2521 3109

# observe breakpoints on time series
ggplot() +
  geom_line(aes(time,brouwer_mean_motion),data=ja2_unpropogated)+
  geom_vline(xintercept=ja2_unpropogated$time[c(2521,3109)],color="red")
# choose 3109

# divide time series data into two periods
## part 1:
ja2_ts1 <- ts(ja2_unpropogated$brouwer_mean_motion[1:3109], start = c(2008,7,4))
## part 2:
ja2_ts2 <- ts(ja2_unpropogated$brouwer_mean_motion[3110:3921], start = c(2017,7,6))
```
## ja2-part1
```{r}
plot(ja2_ts1)

# find outliers
z_scores <- (ja2_ts1 - mean(ja2_ts1)) / sd(ja2_ts1)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(ja2_ts1),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
ja2_ts1_f <- ja2_ts1[-outlier_ind]
```
ACF and PACF
```{r}
acf(ja2_ts1_f)
pacf(ja2_ts1_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(ja2_ts1_f))
pacf(diff(ja2_ts1_f))
print(adf.test(diff(ja2_ts1_f)))
```
Fit models
```{r}
ja2_ts1_fit1 <- arima(ja2_ts1_f, order = c(0, 1, 2))
ja2_ts1_fit2 <- arima(ja2_ts1_f, order = c(1, 1, 2))
ja2_ts1_fit3 <- arima(ja2_ts1_f, order = c(2, 1, 2))
```
```{r}
ja2_ts1_fit1$aic # best
ja2_ts1_fit2$aic
ja2_ts1_fit3$aic 
```
```{r}
sarima(ja2_ts1_f,0,1,2) # good
cpgram(ja2_ts1_fit1$residuals) # not so good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(ja2_ts1_fit1$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- ja2_ts1_fit1$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(ja2_manoeuvres$time_med) == as.Date(ja2_unpropogated$time[1:3109])
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(ja2_unpropogated$time[1:3109])) {
  is_match <- as.Date(ja2_unpropogated$time[1:3109])[i] %in% as.Date(ja2_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
ja2_ts1_date <- final_date_result
ja2_ts1_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.789

```
## ja2-part2
```{r}
plot(ja2_ts2)

# find outliers
z_scores <- (ja2_ts2 - mean(ja2_ts2)) / sd(ja2_ts2)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(ja2_ts2),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
ja2_ts2_f <- ja2_ts2[-outlier_ind]
```
ACF and PACF
```{r}
acf(ja2_ts2_f)
pacf(ja2_ts2_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(ja2_ts2_f))
pacf(diff(ja2_ts2_f))
print(adf.test(diff(ja2_ts2_f)))
```
Fit models
```{r}
ja2_ts2_fit1 <- arima(ja2_ts2_f, order = c(2, 1, 2))
ja2_ts2_fit2 <- arima(ja2_ts2_f, order = c(3, 1, 2))
ja2_ts2_fit3 <- arima(ja2_ts2_f, order = c(2, 1, 3))
ja2_ts2_fit4 <- arima(ja2_ts2_f, order = c(3, 1, 3))
```
```{r}
ja2_ts2_fit1$aic # best
ja2_ts2_fit2$aic
ja2_ts2_fit3$aic 
ja2_ts2_fit4$aic
```
```{r}
sarima(ja2_ts2_f,2,1,2) # good
cpgram(ja2_ts2_fit1$residuals) # good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(ja2_ts2_fit1$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- ja2_ts2_fit1$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(ja2_manoeuvres$time_med) == as.Date(ja2_unpropogated$time[3110:3921])
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(ja2_unpropogated$time[3110:3921])) {
  is_match <- as.Date(ja2_unpropogated$time[3110:3921])[i] %in% as.Date(ja2_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
ja2_ts2_date <- final_date_result
ja2_ts2_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.764
```
## all parts
```{r}
ja2_ts_date <- c(ja2_ts1_date, ja2_ts2_date)
ja2_ts_res <- c(ja2_ts1_res, ja2_ts2_res)
roc_curve <- roc(ja2_ts_date,ja2_ts_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.796
dat <- data.frame(truth = as.factor(ja2_ts_date), pred_1 = as.numeric(ja2_ts_res), pred_2 = 1-as.numeric(ja2_ts_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.407,y=0.193,col="red",pch=8)+
  geom_point(x=0.944,y=0.169,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# ja3
Data preprocessing
```{r}
ja3_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Jason-3.csv")
ja3_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/ja3man.txt",col_names = FALSE)

colname<-c("sate_id","year_begin","day_begin","hour_begin","min_begin","year_end","day_end","hour_end","min_end","type_para","burns","year_med","day_med","hour_med","min_med","second_med","boost_duration","DV1","DV2","DV3","acc1","acc2","acc3","dacc1","dacc2","dacc3")

colnames(ja3_manoeuvres)<-colname

# keep columns with name
ja3_manoeuvres <- ja3_manoeuvres[, 1:26]

ja3_manoeuvres <-
  ja3_manoeuvres %>%
  mutate(
    time_begin=DATETIME(year_begin,day_begin,hour_begin,min_begin,second = c()),
    time_end=DATETIME(year_end,day_end,hour_end,min_end,second = c()),
    time_med=DATETIME(year_med,day_med,hour_med,min_med,second_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(ja3_unpropogated)<-colname_orbit

# keep the first time in a day
ja3_unpropogated <- ja3_unpropogated %>%
  group_by(as.Date(ja3_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
# set up time series
ja3_ts <- ts(ja3_unpropogated$brouwer_mean_motion, start = c(2016,1,31))

# observe if there are structural breaks
plot(ja3_ts)
```
```{r}
# find outliers
z_scores <- (ja3_ts - mean(ja3_ts)) / sd(ja3_ts)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(ja3_ts),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
ja3_ts_f <- ja3_ts[-outlier_ind]
```
ACF and PACF
```{r}
acf(ja3_ts_f)
pacf(ja3_ts_f)
print(adf.test(ja3_ts_f))
```
Fit models
```{r}
ja3_ts_fit1 <- arima(ja3_ts_f, order = c(2, 0, 1))
ja3_ts_fit2 <- arima(ja3_ts_f, order = c(1, 0, 2))
ja3_ts_fit3 <- arima(ja3_ts_f, order = c(2, 0, 2))
```
```{r}
ja3_ts_fit1$aic # best
ja3_ts_fit2$aic
ja3_ts_fit3$aic
```
```{r}
sarima(ja3_ts_f,2,0,1) # bad
cpgram(ja3_ts_fit1$residuals) # not so good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(ja3_ts_fit1$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- ja3_ts_fit1$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(ja3_manoeuvres$time_med) == as.Date(ja3_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(ja3_unpropogated$time)) {
  is_match <- as.Date(ja3_unpropogated$time)[i] %in% as.Date(ja3_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
ja3_ts_date <- final_date_result
ja3_ts_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.888
dat <- data.frame(truth = as.factor(ja3_ts_date), pred_1 = as.numeric(ja3_ts_res), pred_2 = 1-as.numeric(ja3_ts_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.04,y=1,col="red",pch=8)+
  geom_point(x=0.520,y=0.173,col="red",pch=8)+
  coord_equal()



pr_auc(dat, truth, pred_1,event_level = "second")
```


# fy2d
```{r}
fy2d_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Fengyun-2D.csv")
fy2d_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/manFY2D.txt.fy",col_names = FALSE)

colname<-c("unknow1","unknow2","time_begin","time_end")
colnames(fy2d_manoeuvres)<-colname

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")

colnames(fy2d_unpropogated)<-colname_orbit
fy2d_unpropogated<-fy2d_unpropogated[5:nrow(fy2d_unpropogated),]
```
ARIMA
```{r}
# set up time series
fy2d_ts <- ts(fy2d_unpropogated$brouwer_mean_motion, start = c(2011,2,1))

acf(fy2d_ts)
pacf(fy2d_ts)
# The acf shows strong autocorrelations that persist for many months.

ggplot() +
  geom_line(aes(time,brouwer_mean_motion),data=fy2d_unpropogated[1:1000,])+
  geom_vline(xintercept=fy2d_manoeuvres$time_begin,color="red")+
  geom_vline(xintercept=fy2d_manoeuvres$time_end,color="blue")
```
```{r}
# 1st order diff
fy2d_ts_diff <- diff(fy2d_ts)
plot(fy2d_ts_diff)
trend = stats::filter(fy2d_ts_diff, filter = rep(c(1/5), each=5), sides=2)
lines(trend, col = "blue")

acf(fy2d_ts_diff)
pacf(fy2d_ts_diff)
print(adf.test(fy2d_ts_diff))
```
```{r}
# fit model
fy2d_fit1 <- arima(fy2d_ts,order = c(1,1,1))
fy2d_fit2 <- arima(fy2d_ts,order = c(0,1,1))
fy2d_fit3 <- arima(fy2d_ts,order = c(1,1,0))
fy2d_fit4 <- arima(fy2d_ts,order = c(1,0,0))

fy2d_fit1
fy2d_fit2
fy2d_fit3
fy2d_fit4

cpgram(fy2d_fit1$residuals) # good
sarima(fy2d_ts,1,1,1) # good
```
```{r}
full_res <- abs(fy2d_fit1$residuals)

# select dates of manoeuvres in each part
for (i in 1:length(fy2d_unpropogated$time)) {
  is_match <- as.Date(fy2d_unpropogated$time)[i] %in% as.Date(fy2d_manoeuvres$time_begin)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# indicates whether the maneuver actually occurred
j = 1
len=10
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
    final_date_result[j] <- 0
  }
  j <- j+1
}

# indicates whether there is an anomaly in our judgment
j=1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.930
dat <- data.frame(truth = as.factor(final_date_result), pred_1 = as.numeric(final_full_res), pred_2 = 1-as.numeric(final_full_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.455,y=0.556,col="red",pch=8)+
  geom_point(x=0.546,y=0.333,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# fy2e
```{r}
fy2e_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Fengyun-2E.csv")
fy2e_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/manFY2E.txt.fy",col_names = FALSE)

colname<-c("unknow1","unknow2","time_begin","time_end")
colnames(fy2e_manoeuvres)<-colname

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")

colnames(fy2e_unpropogated)<-colname_orbit
fy2e_unpropogated<-fy2e_unpropogated[5:nrow(fy2e_unpropogated),]

```
ARIMA
```{r}
# set up time series
fy2e_ts <- ts(fy2e_unpropogated$brouwer_mean_motion, start = c(2011,3,17))

acf(fy2e_ts)
pacf(fy2e_ts)
# The acf shows strong autocorrelations that persist for many months.

sapply(fy2e_manoeuvres,class)
ggplot() +
  geom_line(aes(time,brouwer_mean_motion),data=fy2e_unpropogated)+
  geom_vline(xintercept=fy2e_manoeuvres$time_begin,color="red")+
  geom_vline(xintercept=fy2e_manoeuvres$time_end,color="blue")
```
```{r}
# remove outliers
outlier1 <- outlier(fy2e_ts)
fy2e_ts_f <- fy2e_ts[-which(fy2e_ts==outlier1)]
plot(fy2e_ts_f)
adf.test(fy2e_ts_f)
acf(fy2e_ts_f)
pacf(fy2e_ts_f)

fy2e_ts_f <- ts(fy2e_ts_f)
```
```{r}
# fit model
fy2e_fit1 <- arima(fy2e_ts_f,order = c(1,1,1))
fy2e_fit2 <- arima(fy2e_ts_f,order = c(0,1,1))
fy2e_fit3 <- arima(fy2e_ts_f,order = c(1,1,0))
fy2e_fit4 <- arima(fy2e_ts_f,order = c(1,0,0))
fy2e_fit5 <- arima(fy2e_ts_f,order = c(1,0,1))

fy2e_fit1
fy2e_fit2
fy2e_fit3
fy2e_fit4
fy2e_fit5

cpgram(fy2e_fit5$residuals) # good
sarima(fy2e_ts_f,1,0,1) # good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(fy2e_fit5$residuals)
spare <- seq(1,length(fy2e_ts),1)
spare[which(fy2e_ts==outlier1)] <- NA
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- fy2e_fit5$residuals[p]
    p <- p+1
  }
}
```
```{r}
# select dates of manoeuvres in each part
same_date <- as.Date(fy2e_manoeuvres$time_begin) == as.Date(fy2e_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(fy2e_unpropogated$time)) {
  is_match <- as.Date(fy2e_unpropogated$time)[i] %in% as.Date(fy2e_manoeuvres$time_begin)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# indicates whether the maneuver actually occurred
j = 1
len=10
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
    final_date_result[j] <- 0
  }
  j <- j+1
}

# indicates whether there is an anomaly in our judgment
j=1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}

final_full_res <- abs(final_full_res)
```
ROC curve
```{r}
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.887
dat <- data.frame(truth = as.factor(final_date_result), pred_1 = as.numeric(final_full_res), pred_2 = 1-as.numeric(final_full_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.595,y=0.219,col="red",pch=8)+
  geom_point(x=0.857,y=0.158,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# fy2f
```{r}
fy2f_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Fengyun-2F.csv")
fy2f_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/manFY2F.txt.fy",col_names = FALSE)

colname<-c("unknow1","unknow2","time_begin","time_end")
colnames(fy2f_manoeuvres)<-colname

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")

colnames(fy2f_unpropogated)<-colname_orbit
fy2f_unpropogated<-fy2f_unpropogated[5:nrow(fy2f_unpropogated),]
```
ARIMA
```{r}
# set up time series
fy2f_ts <- ts(fy2f_unpropogated$brouwer_mean_motion, start = c(2012,9,10))

acf(fy2f_ts)
pacf(fy2f_ts)
# The acf shows strong autocorrelations that persist for many months.

sapply(fy2f_manoeuvres,class)
ggplot() +
  geom_line(aes(time,brouwer_mean_motion),data=fy2f_unpropogated)+
  geom_vline(xintercept=fy2f_manoeuvres$time_begin,color="red")+
  geom_vline(xintercept=fy2f_manoeuvres$time_end,color="blue")
```
```{r}
# 1st order diff
fy2f_ts_diff <- diff(fy2f_ts)
plot(fy2f_ts_diff)
trend = stats::filter(fy2f_ts_diff, filter = rep(c(1/5), each=5), sides=2)
lines(trend, col = "blue")

acf(fy2f_ts_diff)
pacf(fy2f_ts_diff)
print(adf.test(fy2f_ts_diff))
```
```{r}
# fit model
fy2f_fit1 <- arima(fy2f_ts,order = c(1,1,1))
fy2f_fit2 <- arima(fy2f_ts,order = c(1,0,0))
fy2f_fit3 <- arima(fy2f_ts,order = c(1,0,1))
fy2f_fit4 <- arima(fy2f_ts,order = c(1,0,2))
fy2f_fit5 <- arima(fy2f_ts,order = c(2,0,2))

fy2f_fit1
fy2f_fit2
fy2f_fit3
fy2f_fit4
fy2f_fit5

cpgram(fy2f_fit5$residuals) # good
sarima(fy2f_ts,2,0,2) # good
```
```{r}
full_res <- abs(fy2f_fit5$residuals)

# select dates of manoeuvres in each part
same_date <- as.Date(fy2f_manoeuvres$time_begin) == as.Date(fy2f_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(fy2f_unpropogated$time)) {
  is_match <- as.Date(fy2f_unpropogated$time)[i] %in% as.Date(fy2f_manoeuvres$time_begin)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# indicates whether the maneuver actually occurred
j = 1
len=10
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
    final_date_result[j] <- 0
  }
  j <- j+1
}

# indicates whether there is an anomaly in our judgment
j=1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.917
dat <- data.frame(truth = as.factor(final_date_result), pred_1 = as.numeric(final_full_res), pred_2 = 1-as.numeric(final_full_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.862,y=0.275,col="red",pch=8)+
  geom_point(x=0.954,y=0.234,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# fy2h
```{r}
fy2h_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Fengyun-2H.csv")
fy2h_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/manFY2H.txt.fy",col_names = FALSE)

colname<-c("unknow1","unknow2","time_begin","time_end")
colnames(fy2h_manoeuvres)<-colname

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")

colnames(fy2h_unpropogated)<-colname_orbit
fy2h_unpropogated<-fy2h_unpropogated[5:nrow(fy2h_unpropogated),]
```
ARIMA
```{r}
# set up time series
fy2h_ts <- ts(fy2h_unpropogated$brouwer_mean_motion, start = c(2019,1,18))

acf(fy2h_ts)
pacf(fy2h_ts)

# test if stationary
adf.test(fy2h_ts)

sapply(fy2h_manoeuvres,class)
ggplot() +
  geom_line(aes(time,brouwer_mean_motion),data=fy2h_unpropogated)+
  geom_vline(xintercept=fy2h_manoeuvres$time_begin,color="red")+
  geom_vline(xintercept=fy2h_manoeuvres$time_end,color="blue")
```
```{r}
# fit model
fy2h_fit1 <- arima(fy2h_ts,order = c(1,1,1))
fy2h_fit2 <- arima(fy2h_ts,order = c(1,0,0))
fy2h_fit3 <- arima(fy2h_ts,order = c(1,0,1))
fy2h_fit4 <- arima(fy2h_ts,order = c(1,0,2))

fy2h_fit1
fy2h_fit2
fy2h_fit3
fy2h_fit4

cpgram(fy2f_fit2$residuals) # good
sarima(fy2f_ts,1,0,0)
```
```{r}
full_res <- abs(fy2h_fit2$residuals)

# select dates of manoeuvres in each part
same_date <- as.Date(fy2h_manoeuvres$time_begin) == as.Date(fy2h_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(fy2h_unpropogated$time)) {
  is_match <- as.Date(fy2h_unpropogated$time)[i] %in% as.Date(fy2h_manoeuvres$time_begin)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# indicates whether the maneuver actually occurred
j = 1
len=10
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
    final_date_result[j] <- 0
  }
  j <- j+1
}

# indicates whether there is an anomaly in our judgment
j=1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.875
dat <- data.frame(truth = as.factor(final_date_result), pred_1 = as.numeric(final_full_res), pred_2 = 1-as.numeric(final_full_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.3,y=0.333,col="red",pch=8)+
  geom_point(x=0.6,y=0.199,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# fy4a
```{r}
fy4a_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_Fengyun-4A.csv")
fy4a_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/manFY4A.txt.fy",col_names = FALSE)

colname<-c("unknow1","unknow2","time_begin","time_end")
colnames(fy4a_manoeuvres)<-colname

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")

colnames(fy4a_unpropogated)<-colname_orbit
fy4a_unpropogated<-fy4a_unpropogated[5:nrow(fy4a_unpropogated),]
```
ARIMA
```{r}
# set up time series
fy4a_ts <- ts(fy4a_unpropogated$brouwer_mean_motion, start = c(2018,5,22))

acf(fy4a_ts)
pacf(fy4a_ts)

# test if stationary
adf.test(fy4a_ts)

sapply(fy4a_manoeuvres,class)
ggplot() +
  geom_line(aes(time,brouwer_mean_motion),data=fy4a_unpropogated)+
  geom_vline(xintercept=fy4a_manoeuvres$time_begin,color="red")+
  geom_vline(xintercept=fy4a_manoeuvres$time_end,color="blue")
```
```{r}
# fit model
fy4a_fit1 <- arima(fy4a_ts,order = c(1,1,1))
fy4a_fit2 <- arima(fy4a_ts,order = c(1,0,0))
fy4a_fit3 <- arima(fy4a_ts,order = c(1,0,1))
fy4a_fit4 <- arima(fy4a_ts,order = c(2,0,1))
fy4a_fit5 <- arima(fy4a_ts,order = c(2,0,2))

fy4a_fit1
fy4a_fit2
fy4a_fit3
fy4a_fit4
fy4a_fit5

cpgram(fy4a_fit4$residuals) # good
sarima(fy4a_ts,2,0,1) # good
```
```{r}
full_res <- abs(fy4a_fit4$residuals)

# select dates of manoeuvres in each part
same_date <- as.Date(fy4a_manoeuvres$time_begin) == as.Date(fy4a_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(fy4a_unpropogated$time)) {
  is_match <- as.Date(fy4a_unpropogated$time)[i] %in% as.Date(fy4a_manoeuvres$time_begin)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# indicates whether the maneuver actually occurred
j = 1
len=10
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
    final_date_result[j] <- 0
  }
  j <- j+1
}

# indicates whether there is an anomaly in our judgment
j=1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.842
dat <- data.frame(truth = as.factor(final_date_result), pred_1 = as.numeric(final_full_res), pred_2 = 1-as.numeric(final_full_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.902,y=0.394,col="red",pch=8)+
  geom_point(x=0.781,y=0.372,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```


# srl
Data preprocessing
```{r}
srl_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_SARAL.csv")
srl_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/srlman.txt",col_names = FALSE)

colname<-c("sate_id","year_begin","day_begin","hour_begin","min_begin","year_end","day_end","hour_end","min_end","type_para","burns","year_med","day_med","hour_med","min_med","second_med","boost_duration","DV1","DV2","DV3","acc1","acc2","acc3","dacc1","dacc2","dacc3")

colnames(srl_manoeuvres)<-colname

srl_manoeuvres <-
  srl_manoeuvres %>%
  mutate(
    time_begin=DATETIME(year_begin,day_begin,hour_begin,min_begin,second = c()),
    time_end=DATETIME(year_end,day_end,hour_end,min_end,second = c()),
    time_med=DATETIME(year_med,day_med,hour_med,min_med,second_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(srl_unpropogated)<-colname_orbit

# keep the first time in a day
srl_unpropogated <- srl_unpropogated %>%
  group_by(as.Date(srl_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
# set up time series
srl_ts <- ts(srl_unpropogated$brouwer_mean_motion, start = c(2013,3,10))

# observe if there are structural breaks
plot(srl_ts)

# computation of breakpoints in regression relationships
##########breakpoints(srl_ts ~ 1)$breakpoints
# ouput: 1045 1661 2624

# observe breakpoints on time series
ggplot() +
  geom_line(aes(time,brouwer_mean_motion),data=srl_unpropogated)+
  geom_vline(xintercept=srl_unpropogated$time[c(1045, 1661, 2624)],color="red")
# choose 1045

# divide time series data into two periods
## part 1:
srl_ts1 <- ts(srl_unpropogated$brouwer_mean_motion[1:1045], start = c(2013,3,10))
## part 2:
srl_ts2 <- ts(srl_unpropogated$brouwer_mean_motion[1046:3290], start = c(2016,7,5))
```
## srl-part1
```{r}
plot(srl_ts1)

# find outliers
z_scores <- (srl_ts1 - mean(srl_ts1)) / sd(srl_ts1)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(srl_ts1),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
srl_ts1_f <- srl_ts1[-outlier_ind]
```
ACF and PACF
```{r}
acf(srl_ts1_f)
pacf(srl_ts1_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(srl_ts1_f))
pacf(diff(srl_ts1_f))
print(adf.test(diff(srl_ts1_f)))
```
Fit models
```{r}
srl_ts1_fit1 <- arima(srl_ts1_f, order = c(2, 1, 2))
srl_ts1_fit2 <- arima(srl_ts1_f, order = c(3, 1, 2))
srl_ts1_fit3 <- arima(srl_ts1_f, order = c(2, 1, 3))
srl_ts1_fit4 <- arima(srl_ts1_f, order = c(3, 1, 3))
srl_ts1_fit5 <- arima(srl_ts1_f, order = c(3, 1, 4))
srl_ts1_fit6 <- arima(srl_ts1_f, order = c(4, 1, 3))
srl_ts1_fit7 <- arima(srl_ts1_f, order = c(4, 1, 4))
```
```{r}
srl_ts1_fit1$aic
srl_ts1_fit2$aic
srl_ts1_fit3$aic
srl_ts1_fit4$aic
srl_ts1_fit5$aic # best
srl_ts1_fit6$aic 
srl_ts1_fit7$aic
```
```{r}
sarima(srl_ts1_f,3,1,4) # good
cpgram(srl_ts1_fit5$residuals) # good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(srl_ts1_fit5$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- srl_ts1_fit5$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(srl_manoeuvres$time_med) == as.Date(srl_unpropogated$time[1:1045])
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(srl_unpropogated$time[1:1045])) {
  is_match <- as.Date(srl_unpropogated$time[1:1045])[i] %in% as.Date(srl_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
srl_ts1_date <- final_date_result
srl_ts1_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.809
```
## srl-part2
```{r}
plot(srl_ts2)

# find outliers
z_scores <- (srl_ts2 - mean(srl_ts2)) / sd(srl_ts2)
outlier_ind <- which(abs(z_scores) > 3)
# no outliers
```
ACF and PACF
```{r}
acf(srl_ts2)
pacf(srl_ts2)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(srl_ts2))
pacf(diff(srl_ts2))
print(adf.test(diff(srl_ts2)))
```
Fit models
```{r}
srl_ts2_fit1 <- arima(srl_ts2, order = c(0, 1, 1))
srl_ts2_fit2 <- arima(srl_ts2, order = c(0, 1, 2))
srl_ts2_fit3 <- arima(srl_ts2, order = c(1, 1, 1))
srl_ts2_fit4 <- arima(srl_ts2, order = c(1, 1, 2))
srl_ts2_fit5 <- arima(srl_ts2, order = c(2, 1, 2))
```
```{r}
srl_ts2_fit1$aic # best
srl_ts2_fit2$aic
srl_ts2_fit3$aic 
srl_ts2_fit4$aic
srl_ts2_fit5$aic
```
```{r}
sarima(srl_ts2,0,1,1) # good
cpgram(srl_ts2_fit1$residuals) # good
```
```{r}
# select dates of manoeuvres in each part
same_date <- as.Date(srl_manoeuvres$time_med) == as.Date(srl_unpropogated$time[1046:3290])
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(srl_unpropogated$time[1046:3290])) {
  is_match <- as.Date(srl_unpropogated$time[1046:3290])[i] %in% as.Date(srl_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(srl_ts2_fit1$residuals)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
srl_ts2_date <- final_date_result
srl_ts2_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.998
```
## all parts
```{r}
srl_ts_date <- c(srl_ts1_date, srl_ts2_date)
srl_ts_res <- c(srl_ts1_res, srl_ts2_res)
roc_curve <- roc(srl_ts_date,srl_ts_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.947
dat <- data.frame(truth = as.factor(srl_ts_date), pred_1 = as.numeric(srl_ts_res), pred_2 = 1-as.numeric(srl_ts_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.143,y=0.143,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")
```

#TOPEX
Data preprocessing
```{r}
top_unpropogated<-read_csv("C:/Users/11961/Desktop/study/satellite_data/orbital_elements/unpropagated_elements_TOPEX.csv")
top_manoeuvres<-read_table("C:/Users/11961/Desktop/study/satellite_data/manoeuvres/topman.txt",col_names = FALSE)

colname<-c("sate_id","year_med","day_med","hour_med","min_med")
colnames(top_manoeuvres)<-colname
top_manoeuvres<-top_manoeuvres[,1:5]

top_DATETIME<-function(year,day,hour,minute){
  time=paste(hour,minute,sep=":")
  day=as.numeric(day)
  date=case_when(
    year == 1992 ~ as.Date(day-1,origin="1992-01-01"),
    year == 1993 ~ as.Date(day-1,origin="1993-01-01"),
    year == 1994 ~ as.Date(day-1,origin="1994-01-01"),
    year == 1995 ~ as.Date(day-1,origin="1995-01-01"),
    year == 1996 ~ as.Date(day-1,origin="1996-01-01"),
    year == 1997 ~ as.Date(day-1,origin="1997-01-01"),
    year == 1998 ~ as.Date(day-1,origin="1998-01-01"),
    year == 1999 ~ as.Date(day-1,origin="1999-01-01"),
    year == 2000 ~ as.Date(day-1,origin="2000-01-01"),
    year == 2001 ~ as.Date(day-1,origin="2001-01-01"),
    year == 2002 ~ as.Date(day-1,origin="2002-01-01"),
    year == 2003 ~ as.Date(day-1,origin="2003-01-01"),
    year == 2004 ~ as.Date(day-1,origin="2004-01-01")
  )
  datetime=paste(date,time)
  datetime=as.POSIXct(datetime,TZ="UTC")
  return(datetime)
}

top_manoeuvres <-
top_manoeuvres %>%
  mutate(
    time_med=top_DATETIME(year_med,day_med,hour_med,min_med),
    .keep="unused"
  )

colname_orbit<-c("time","eccentricity","argument_of_perigee","inclination","mean_anomaly","brouwer_mean_motion","right_ascension")
colnames(top_unpropogated)<-colname_orbit

# keep the first time in a day
top_unpropogated <- top_unpropogated %>%
  group_by(as.Date(top_unpropogated$time)) %>%
  filter(row_number() == 1) %>%
  ungroup()
```
Set up time series
```{r}
# set up time series
top_ts <- ts(top_unpropogated$brouwer_mean_motion, start = c(1992,8,27))

# observe if there are structural breaks
plot(top_ts)
```
```{r}
# find outliers
z_scores <- (top_ts - mean(top_ts)) / sd(top_ts)
outlier_ind <- which(abs(z_scores) > 3)

# assign the outliers to NA
spare <- seq(1,length(top_ts),1)
spare[outlier_ind] <- NA

# remove outliers (f: filtered)
top_ts_f <- top_ts[-outlier_ind]
```
ACF and PACF
```{r}
acf(top_ts_f)
pacf(top_ts_f)
```
Observe autocorrelation, then decide to take the difference
```{r}
acf(diff(top_ts_f))
pacf(diff(top_ts_f))
print(adf.test(diff(top_ts_f)))
```
Fit models
```{r}
top_ts_fit1 <- arima(top_ts_f, order = c(1, 1, 1))
top_ts_fit2 <- arima(top_ts_f, order = c(2, 1, 1))
top_ts_fit3 <- arima(top_ts_f, order = c(1, 1, 2))
top_ts_fit4 <- arima(top_ts_f, order = c(2, 1, 2))
top_ts_fit5 <- arima(top_ts_f, order = c(2, 1, 3))
top_ts_fit6 <- arima(top_ts_f, order = c(3, 1, 2))
top_ts_fit7 <- arima(top_ts_f, order = c(3, 1, 3))
```
```{r}
top_ts_fit1$aic 
top_ts_fit2$aic
top_ts_fit3$aic
top_ts_fit4$aic 
top_ts_fit5$aic
top_ts_fit6$aic 
top_ts_fit7$aic # best
```
```{r}
sarima(top_ts_f,3,1,3) # bad
cpgram(top_ts_fit7$residuals) # not very good
```
```{r}
# assign the highest residuals to the outliers
max_res <- max(top_ts_fit7$residuals)
full_res <- spare 
p=1
for(i in 1:length(spare)){
  if(is.na(spare[i])){
    full_res[i] <- max_res
  }
  else{
    full_res[i] <- top_ts_fit1$residuals[p]
    p <- p+1
  }
}

# select dates of manoeuvres in each part
same_date <- as.Date(top_manoeuvres$time_med) == as.Date(top_unpropogated$time)
date_result <- ifelse(same_date, 1, 0)
for (i in 1:length(top_unpropogated$time)) {
  is_match <- as.Date(top_unpropogated$time)[i] %in% as.Date(top_manoeuvres$time_med)
  date_result[i] <- ifelse(is_match, 1, 0)
}

# taking the residuals to their absolute values
full_res <- abs(full_res)
```
Set window length, prepare parameters for ROC
```{r}
# indicates whether the maneuver actually occurred
j <- 1
len <- 3 # window length 
final_date_result <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  if(sum(date_result[i:(i+len)])>0){
    final_date_result[j] <- 1
  }
  else{
  final_date_result[j] <- 0
  }
  j <- j+1

}

# indicates whether there is an anomaly in our judgment
j <- 1
final_full_res <- 0
for (i in seq(1,length(date_result)-len,by=len)){
  final_full_res[j] <- max(full_res[i:(i+len)])
  j <- j+1
}
```
ROC curve
```{r}
top_ts_date <- final_date_result
top_ts_res <- final_full_res
roc_curve <- roc(final_date_result,final_full_res)
plot(roc_curve, print.auc = TRUE, print.auc.x = 0.25, print.auc.y = 0.7, auc.polygon = TRUE)
# 0.696
dat <- data.frame(truth = as.factor(top_ts_date), pred_1 = as.numeric(top_ts_res), pred_2 = 1-as.numeric(top_ts_res))

pr_dat <- pr_curve(dat, truth, pred_1,event_level = "second")
pr_dat %>%
  arrange(.threshold) %>% # this step is not strictly necessary here because the rows are already ordered by `.threshold`
  ggplot() +
  geom_path(aes(recall, precision)) + 
  geom_point(x=0.077,y=0.5,col="red",pch=8)+
  geom_point(x=0.923,y=0.031,col="red",pch=8)+
  coord_equal()

pr_auc(dat, truth, pred_1,event_level = "second")

```

